<html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACWR+ Tracker - Cloud Synced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #522d80 0%, #3d1f5f 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            font-size: 2.5rem; 
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #522d80 0%, #3d1f5f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .stonehill-logo {
            width: 60px;
            height: 60px;
            background: #522d80;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 900;
            font-family: Georgia, serif;
            box-shadow: 0 4px 12px rgba(82, 45, 128, 0.3);
        }
        .subtitle { color: #6b7280; margin-bottom: 2rem; font-size: 1.1rem; }
        .cloud-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 1rem;
        }
        .cloud-status.connected { background: #dcfce7; color: #16a34a; }
        .cloud-status.disconnected { background: #fee2e2; color: #dc2626; }
        .tabs { 
            display: flex; 
            gap: 0.5rem; 
            border-bottom: 2px solid #e5e7eb; 
            margin-bottom: 2rem; 
            flex-wrap: wrap;
        }
        .tab { 
            padding: 0.75rem 1.5rem; 
            background: none; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            margin-bottom: -2px;
            transition: all 0.3s;
            font-size: 1rem;
        }
        .tab.active { 
            color: #522d80; 
            border-bottom-color: #522d80; 
        }
        .tab:hover { color: #522d80; }
        .card { 
            background: #f9fafb; 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .form-group { margin-bottom: 1rem; }
        label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 0.5rem; 
            font-size: 0.875rem;
            color: #374151;
        }
        input, select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid #d1d5db; 
            border-radius: 0.5rem; 
            font-size: 1rem;
            transition: border 0.3s;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #522d80;
        }
        button { 
            padding: 0.75rem 1.5rem; 
            background: linear-gradient(135deg, #522d80 0%, #3d1f5f 100%);
            color: white; 
            border: none; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1rem;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(82, 45, 128, 0.4);
        }
        button:active { transform: translateY(0); }
        button:disabled { 
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
        .btn-success:hover { box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .btn-danger:hover { box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4); }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
        .metric-card { 
            background: white; 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .metric-card:hover { transform: translateY(-4px); }
        .metric-card.green { border-left-color: #16a34a; }
        .metric-card.purple { border-left-color: #522d80; }
        .metric-card.blue { border-left-color: #2563eb; }
        .metric-card.orange { border-left-color: #f59e0b; }
        .metric-title { 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #6b7280; 
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .metric-value { font-size: 2.5rem; font-weight: 900; }
        .throw-list { max-height: 300px; overflow-y: auto; }
        .throw-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.75rem; 
            background: white; 
            border-radius: 0.5rem; 
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-badge { 
            display: inline-block; 
            padding: 0.5rem 1rem; 
            border-radius: 9999px; 
            font-weight: 700; 
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        .status-optimal { background: #dcfce7; color: #16a34a; }
        .status-caution { background: #fef3c7; color: #ca8a04; }
        .status-danger { background: #fee2e2; color: #dc2626; }
        .status-under { background: #dbeafe; color: #2563eb; }
        .hero-status { 
            padding: 2rem; 
            border-radius: 1rem; 
            border: 4px solid; 
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .hero-status.optimal { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-color: #16a34a; }
        .hero-status.caution { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: #ca8a04; }
        .hero-status.danger { background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: #dc2626; }
        .hero-status.under { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-color: #2563eb; }
        .recovery-inputs { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem; 
            background: #eff6ff; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            border: 2px solid #bfdbfe;
        }
        @media (max-width: 768px) {
            .recovery-inputs { grid-template-columns: 1fr; }
        }
        .hidden { display: none; }
        .input-row { display: flex; gap: 0.5rem; }
        .flex-1 { flex: 1; }
        .info-box { 
            background: #eff6ff; 
            border: 2px solid #bfdbfe; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            margin-top: 1rem;
        }
        .session-item { 
            padding: 1rem; 
            border: 2px solid #e5e7eb; 
            border-radius: 0.5rem; 
            margin-bottom: 0.5rem;
            background: white;
            transition: border-color 0.2s;
        }
        .session-item:hover { border-color: #522d80; }
        .zone-badges { 
            display: flex; 
            gap: 0.5rem; 
            flex-wrap: wrap; 
            margin-top: 0.5rem; 
        }
        .zone-badge { 
            padding: 0.25rem 0.5rem; 
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
            font-weight: 600;
        }
        .zone-badge.z10 { background: #7f1d1d; color: white; }
        .zone-badge.z9 { background: #dc2626; color: white; }
        .zone-badge.z8 { background: #f97316; color: white; }
        .zone-badge.z7 { background: #fb923c; color: white; }
        .zone-badge.z6 { background: #fbbf24; color: #78350f; }
        .zone-badge.z5 { background: #facc15; color: #78350f; }
        .zone-badge.z4 { background: #bef264; color: #365314; }
        .zone-badge.z3 { background: #86efac; color: #14532d; }
        .zone-badge.z2 { background: #6ee7b7; color: #064e3b; }
        .zone-badge.z1 { background: #99f6e4; color: #134e4a; }
        .player-card {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .player-card:hover {
            border-color: #522d80;
            transform: translateX(4px);
        }
        .player-card.active {
            border-color: #522d80;
            background: #f3f4f6;
            border-width: 3px;
        }
        .effort-zone-chart {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 0.25rem;
            margin-top: 1rem;
            height: 120px;
        }
        .zone-bar {
            background: #e5e7eb;
            border-radius: 0.25rem;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            position: relative;
            transition: all 0.3s;
        }
        .zone-bar:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .zone-fill {
            width: 100%;
            border-radius: 0.25rem;
            transition: height 0.5s ease;
        }
        .zone-label {
            font-size: 0.65rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        .zone-count {
            position: absolute;
            top: -1.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: #374151;
        }
        .setup-banner {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid #ca8a04;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .setup-banner h2 {
            color: #92400e;
            margin-bottom: 0.5rem;
        }
        .setup-banner code {
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
	<div id="login-screen">
	  <h2>Login</h2>
	  <input id="email" placeholder="Email">
	  <input id="password" type="password" placeholder="Password">
	  <button onclick="login()">Login / Register</button>
	</div>
    <div id="app-screen" class="container hidden">
        <h1>
            <div class="stonehill-logo">S</div>
            <span>ACWR+ Tracker</span>
            <span class="cloud-status" id="cloud-status">
                <span id="status-icon">‚ö†Ô∏è</span>
                <span id="status-text">Not Connected</span>
            </span>
        </h1>
        <p class="subtitle">Stonehill College Baseball ‚Ä¢ Cloud Synced Multi-Player Tracker</p>
        
        <div id="setup-required" class="setup-banner">
            <h2>üîß Firebase Setup Required</h2>
            <p style="margin-bottom: 1rem;">To enable cloud sync, you need to configure Firebase. Follow these steps:</p>
            <ol style="margin-left: 1.5rem; margin-bottom: 1rem; line-height: 1.8;">
                <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color: #2563eb;">Firebase Console</a></li>
                <li>Create a new project (or use existing)</li>
                <li>Add a Web App and copy the config</li>
                <li>Enable Firestore Database in "test mode"</li>
                <li>Open browser console (F12) and look for <code>firebaseConfig</code> variable</li>
                <li>Replace the config in the HTML file (scroll to bottom of code)</li>
            </ol>
            <p style="color: #92400e; font-weight: 600;">üí° Until configured, data will save locally to your browser only.</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('players')">üë• Players</button>
            <button class="tab" onclick="showTab('input')">üì• Data Input</button>
            <button class="tab" onclick="showTab('dashboard')">üìä Dashboard</button>
        </div>
        
        <!-- PLAYERS TAB -->
        <div id="players-tab">
            <div class="grid-2">
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Add New Player</h3>
                    <div class="form-group">
                        <label>Player Name</label>
                        <input type="text" id="player-name" placeholder="Enter player name">
                    </div>
                    <div class="form-group">
                        <label>Max Velocity (mph)</label>
                        <input type="number" id="player-max-velo" placeholder="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="player-position">
                            <option value="SP">Starting Pitcher</option>
                            <option value="RP">Relief Pitcher</option>
                            <option value="C">Catcher</option>
                            <option value="IF">Infielder</option>
                            <option value="OF">Outfielder</option>
                        </select>
                    </div>
                    <button class="btn-success" onclick="addPlayer()" style="width: 100%;">‚ûï Add Player</button>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Player Roster</h3>
                    <div id="player-list"></div>
                </div>
            </div>
        </div>
        
        <!-- INPUT TAB -->
        <div id="input-tab" class="hidden">
            <div class="card" style="background: #eff6ff; border: 2px solid #bfdbfe; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>Current Player:</strong> 
                        <span id="current-player-name" style="font-size: 1.25rem; color: #522d80;">None selected</span>
                    </div>
                    <button onclick="showTab('players')" class="btn-small">Change Player</button>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Add Throwing Session</h3>
                    
                    <div class="form-group">
                        <label>Session Date</label>
                        <input type="date" id="session-date">
                    </div>
                    
                    <div class="recovery-inputs">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Sleep Score (0-100)</label>
                            <input type="number" id="sleep-score" placeholder="Optional" min="0" max="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>HRV (RMSSD)</label>
                            <input type="number" id="hrv" placeholder="Optional">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Resting HR (bpm)</label>
                            <input type="number" id="rhr" placeholder="Optional">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label>Add Throws (Type velocity and press Enter)</label>
                        <div class="input-row">
                            <input type="number" id="throw-velo" placeholder="Velocity (mph)" step="0.1" class="flex-1">
                            <button onclick="addThrow()">Add</button>
                        </div>
                        <div id="throw-preview" class="info-box hidden"></div>
                    </div>
                    
                    <div id="current-session" class="hidden">
                        <h4>Current Session (<span id="throw-count">0</span> throws)</h4>
                        <div class="throw-list" id="throw-list"></div>
                        <div style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 2px solid #e5e7eb; margin-top: 1rem; font-weight: bold;">
                            <span>Total Workload:</span>
                            <span id="total-workload" style="font-size: 1.5rem; color: #522d80;">0.000</span>
                        </div>
                    </div>
                    
                    <button class="btn-success" onclick="saveSession()" style="width: 100%; margin-top: 1rem;" id="save-btn" disabled>üíæ Save Session</button>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Effort Zone Distribution</h3>
                    <div id="effort-zones-display"></div>
                    
                    <h3 style="margin: 1.5rem 0 1rem;">Recent Sessions</h3>
                    <div id="sessions-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab" class="hidden">
            <div class="card" style="background: #eff6ff; border: 2px solid #bfdbfe; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>Viewing Dashboard for:</strong> 
                        <span id="dashboard-player-name" style="font-size: 1.25rem; color: #522d80;">None selected</span>
                    </div>
                    <button onclick="showTab('players')" class="btn-small">Change Player</button>
                </div>
            </div>
            <div id="dashboard-content"></div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
	<script type="module">
	    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
	
	    import {
	        getFirestore,
	        collection,
	        doc,
	        setDoc,
	        getDoc,
	        getDocs,
	        deleteDoc,
	        onSnapshot
	    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
	
	    import {
	        getAuth,
	        signInWithEmailAndPassword,
	        createUserWithEmailAndPassword,
	        onAuthStateChanged
	    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
	
	    // ‚ö†Ô∏è REPLACE THIS WITH YOUR FIREBASE CONFIG ‚ö†Ô∏è
	    const firebaseConfig = {
	        apiKey: "YOUR_API_KEY_HERE",
	        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
	        projectId: "YOUR_PROJECT_ID",
	        storageBucket: "YOUR_PROJECT_ID.appspot.com",
	        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
	        appId: "YOUR_APP_ID"
	    };
	
	    let db = null;
	    let auth = null;
	    let isFirebaseConfigured = false;
	
	    if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
	        try {
	            const app = initializeApp(firebaseConfig);
	
	            // üî• Firestore
	            db = getFirestore(app);
	
	            // üîê Auth
	            auth = getAuth(app);
	
	            isFirebaseConfigured = true;
	            updateCloudStatus('connected');
	            document.getElementById('setup-required').style.display = 'none';
	
	            console.log('‚úÖ Firebase + Auth connected successfully!');
	        } catch (error) {
	            console.error('Firebase initialization error:', error);
	            updateCloudStatus('disconnected');
	        }
	    } else {
	        console.log('‚ö†Ô∏è Firebase not configured - using local storage only');
	        updateCloudStatus('disconnected');
	    }
	
	    function updateCloudStatus(status) {
	        const statusEl = document.getElementById('cloud-status');
	        const iconEl = document.getElementById('status-icon');
	        const textEl = document.getElementById('status-text');
	
	        if (status === 'connected') {
	            statusEl.className = 'cloud-status connected';
	            iconEl.textContent = '‚òÅÔ∏è';
	            textEl.textContent = 'Cloud Synced';
	        } else {
	            statusEl.className = 'cloud-status disconnected';
	            iconEl.textContent = '‚ö†Ô∏è';
	            textEl.textContent = 'Local Only';
	        }
	    }
	
	    // üåç Expose globally (critical)
	    window.db = db;
	    window.auth = auth;
	    window.isFirebaseConfigured = isFirebaseConfigured;
	
	    window.firestore = {
	        collection,
	        doc,
	        setDoc,
	        getDoc,
	        getDocs,
	        deleteDoc,
	        onSnapshot
	    };
	
	    window.firebaseAuth = {
	        signInWithEmailAndPassword,
	        createUserWithEmailAndPassword,
	        onAuthStateChanged
	    };
	</script>

	<script>
	function login() {
	    const email = document.getElementById('email').value;
	    const password = document.getElementById('password').value;
	
	    firebaseAuth
	        .signInWithEmailAndPassword(auth, email, password)
	        .catch(() => {
	            return firebaseAuth.createUserWithEmailAndPassword(auth, email, password);
	        })
	        .catch(err => alert(err.message));
	}
	</script>

	<script>
	firebaseAuth.onAuthStateChanged(window.auth, (user) => {
	    if (!user) {
	        document.getElementById('login-screen').style.display = 'block';
	        document.getElementById('app-screen').classList.add('hidden');
	        return;
	    }
	
	    window.currentUserId = user.uid;
	
	    document.getElementById('login-screen').style.display = 'none';
	    document.getElementById('app-screen').classList.remove('hidden');
	
	    loadPlayersFromCloud();
	});
	</script>	
    
    <script>
        const BRN_ZONES = [
            {minPercent: 0, maxPercent: 53, value: 0.02},
            {minPercent: 53, maxPercent: 59, value: 0.03},
            {minPercent: 59, maxPercent: 64, value: 0.03},
            {minPercent: 64, maxPercent: 69, value: 0.04},
            {minPercent: 69, maxPercent: 75, value: 0.06},
            {minPercent: 75, maxPercent: 81, value: 0.07},
            {minPercent: 81, maxPercent: 86, value: 0.09},
            {minPercent: 86, maxPercent: 92, value: 0.12},
            {minPercent: 92, maxPercent: 98, value: 0.18},
            {minPercent: 98, maxPercent: 100, value: 0.35}
        ];
        
        const ZONE_COLORS = {
            z10: '#7f1d1d', z9: '#dc2626', z8: '#f97316', z7: '#fb923c', z6: '#fbbf24',
            z5: '#facc15', z4: '#bef264', z3: '#86efac', z2: '#6ee7b7', z1: '#99f6e4'
        };
        
        const ACUTE_KERNEL = [0.7, 0.77, 0.83, 0.90, 0.97, 1.03, 1.10, 1.17, 1.23, 1.3];
        
        let players = [];
        let currentPlayerId = localStorage.getItem('current_player_id');
        let currentThrows = [];
        
        document.getElementById('session-date').valueAsDate = new Date();
        
        document.getElementById('throw-velo').addEventListener('keypress', e => {
            if (e.key === 'Enter') addThrow();
        });
        document.getElementById('throw-velo').addEventListener('input', updatePreview);
        
        // Load players on startup
        window.login = async function () {
		  const email = document.getElementById("email").value;
		  const password = document.getElementById("password").value;
		
		  try {
		    await signInWithEmailAndPassword(auth, email, password);
		  } catch {
		    await createUserWithEmailAndPassword(auth, email, password);
		  }
		};
		async function loadPlayersFromCloud() {
            if (!window.isFirebaseConfigured) {
                players = JSON.parse(localStorage.getItem('acwr_players') || '[]');
                loadPlayers();
                return;
            }
            
            try {
                const playersCol = window.firestore.collection(window.db, 'players');
                const snapshot = await window.firestore.getDocs(playersCol);
                players = [];
                snapshot.forEach(doc => {
                    players.push({ id: doc.id, ...doc.data() });
                });
                loadPlayers();
                console.log(`Loaded ${players.length} players from cloud`);
            } catch (error) {
                console.error('Error loading players:', error);
                players = JSON.parse(localStorage.getItem('acwr_players') || '[]');
                loadPlayers();
            }
        }
        
        async function addPlayer() {
            const name = document.getElementById('player-name').value.trim();
            const maxVelo = parseFloat(document.getElementById('player-max-velo').value);
            const position = document.getElementById('player-position').value;
            
            if (!name || !maxVelo) {
                alert('Please enter player name and max velocity');
                return;
            }
            
            const player = {
                id: Date.now().toString(),
                name,
                maxVelo,
                position,
                sessions: []
            };
            
            if (window.isFirebaseConfigured) {
                try {
                    const playerDoc = window.firestore.doc(window.db, 'players', player.id);
                    await window.firestore.setDoc(playerDoc, player);
                    console.log('‚úÖ Player saved to cloud');
                } catch (error) {
                    console.error('Error saving player:', error);
                    alert('Cloud save failed, saving locally only');
                }
            }
            
            // Also save to localStorage as backup
            players.push(player);
            localStorage.setItem('acwr_players', JSON.stringify(players));
            
            document.getElementById('player-name').value = '';
            document.getElementById('player-max-velo').value = '';
            loadPlayers();
            alert(`‚úÖ ${name} added to roster!`);
        }
        
        function loadPlayers() {
            const list = document.getElementById('player-list');
            if (players.length === 0) {
                list.innerHTML = '<p style="color: #6b7280;">No players yet. Add your first player!</p>';
                return;
            }
            
            list.innerHTML = players.map(p => `
                <div class="player-card ${p.id === currentPlayerId ? 'active' : ''}" onclick="selectPlayer('${p.id}')">
                    <div>
                        <strong style="font-size: 1.1rem;">${p.name}</strong>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                            ${p.position} ‚Ä¢ Max: ${p.maxVelo} mph ‚Ä¢ ${p.sessions?.length || 0} sessions
                        </div>
                    </div>
                    <button onclick="deletePlayer('${p.id}'); event.stopPropagation();" class="btn-danger btn-small">Delete</button>
                </div>
            `).join('');
        }
        
        function selectPlayer(id) {
            currentPlayerId = id;
            localStorage.setItem('current_player_id', id);
            loadPlayers();
            updateCurrentPlayerDisplay();
            showTab('input');
        }
        
        async function deletePlayer(id) {
            if (!confirm('Delete this player and all their data?')) return;
            
            if (window.isFirebaseConfigured) {
                try {
                    const playerDoc = window.firestore.doc(window.db, 'players', id);
                    await window.firestore.deleteDoc(playerDoc);
                    console.log('‚úÖ Player deleted from cloud');
                } catch (error) {
                    console.error('Error deleting player:', error);
                }
            }
            
            players = players.filter(p => p.id !== id);
            if (currentPlayerId === id) {
                currentPlayerId = players[0]?.id || null;
                localStorage.setItem('current_player_id', currentPlayerId);
            }
            localStorage.setItem('acwr_players', JSON.stringify(players));
            loadPlayers();
            updateCurrentPlayerDisplay();
        }
        
        function getCurrentPlayer() {
            return players.find(p => p.id === currentPlayerId);
        }
        
        function updateCurrentPlayerDisplay() {
            const player = getCurrentPlayer();
            const names = document.querySelectorAll('#current-player-name, #dashboard-player-name');
            names.forEach(el => el.textContent = player ? `${player.name} (${player.maxVelo} mph)` : 'None selected');
        }
        
        function calculateThrowValue(maxVelo, throwVelo) {
            const percentage = (throwVelo / maxVelo) * 100;
            let zone = BRN_ZONES.find(z => percentage >= z.minPercent && percentage < z.maxPercent);
            if (!zone) zone = percentage < 53 ? BRN_ZONES[0] : BRN_ZONES[BRN_ZONES.length - 1];
            
            const zoneIdx = BRN_ZONES.indexOf(zone);
            if (zoneIdx < BRN_ZONES.length - 1 && percentage > zone.minPercent) {
                const nextZone = BRN_ZONES[zoneIdx + 1];
                const progress = (percentage - zone.minPercent) / (zone.maxPercent - zone.minPercent);
                return zone.value + (nextZone.value - zone.value) * progress;
            }
            return zone.value;
        }
        
        function getZoneName(maxVelo, throwVelo) {
            const pct = (throwVelo / maxVelo) * 100;
            if (pct >= 98) return "z10";
            if (pct >= 92) return "z9";
            if (pct >= 86) return "z8";
            if (pct >= 81) return "z7";
            if (pct >= 75) return "z6";
            if (pct >= 69) return "z5";
            if (pct >= 64) return "z4";
            if (pct >= 59) return "z3";
            if (pct >= 53) return "z2";
            return "z1";
        }
        
        function calculateWorkload(throws, maxVelo) {
            return throws.reduce((sum, t) => 
                sum + calculateThrowValue(maxVelo, t.velocity) * t.count, 0);
        }
        
        function normalizeSleep(score) { return 0.7 + (score / 100) * 0.6; }
        function normalizeHRV(hrv) { return 0.7 + ((hrv - 30) / 70) * 0.6; }
        function normalizeRHR(rhr) { return 1.3 - ((rhr - 45) / 35) * 0.6; }
        
        function calculateReadiness(session) {
            const scores = [];
            if (session.sleepScore) scores.push({value: normalizeSleep(session.sleepScore), weight: 0.5});
            if (session.hrv) scores.push({value: Math.max(0.7, Math.min(1.3, normalizeHRV(session.hrv))), weight: 0.3});
            if (session.rhr) scores.push({value: Math.max(0.7, Math.min(1.3, normalizeRHR(session.rhr))), weight: 0.2});
            
            if (scores.length === 0) return 1.0;
            const totalWeight = scores.reduce((sum, s) => sum + s.weight, 0);
            const weightedSum = scores.reduce((sum, s) => sum + s.value * s.weight, 0);
            return weightedSum / totalWeight;
        }
        
        function calculateACWR(sessions) {
            if (!sessions || sessions.length < 9) return null;
            
            const sorted = sessions.sort((a, b) => new Date(a.date) - new Date(b.date));
            const last28 = sorted.slice(-28);
            const last9 = last28.slice(-9);
            
            const weightSum = ACUTE_KERNEL.reduce((a, b) => a + b, 0);
            const weightedSum = last9.reduce((sum, s, i) => 
                sum + s.workload * ACUTE_KERNEL[8 - i], 0);
            const acute = weightedSum / weightSum;
            
            const chronic = last28.reduce((sum, s) => sum + s.workload, 0) / last28.length;
            const rawAcwr = chronic > 0 ? acute / chronic : 0;
            const readiness = calculateReadiness(sorted[sorted.length - 1]);
            const adjustedAcwr = rawAcwr / readiness;
            
            let status;
            if (adjustedAcwr < 0.7) status = "under";
            else if (adjustedAcwr <= 1.3) status = "optimal";
            else if (adjustedAcwr <= 1.5) status = "caution";
            else status = "danger";
            
            return {
                acwr: adjustedAcwr.toFixed(2),
                rawAcwr: rawAcwr.toFixed(2),
                acute: acute.toFixed(1),
                chronic: chronic.toFixed(1),
                readiness: readiness.toFixed(2),
                status
            };
        }
        
        function updatePreview() {
            const player = getCurrentPlayer();
            if (!player) return;
            
            const velo = parseFloat(document.getElementById('throw-velo').value);
            const preview = document.getElementById('throw-preview');
            
            if (velo) {
                const pct = ((velo / player.maxVelo) * 100).toFixed(1);
                const zone = getZoneName(player.maxVelo, velo).toUpperCase();
                preview.classList.remove('hidden');
                preview.innerHTML = `<strong>${velo} mph = ${pct}% of max (${zone})</strong>`;
            } else {
                preview.classList.add('hidden');
            }
        }
        
        function addThrow() {
            const player = getCurrentPlayer();
            if (!player) {
                alert('Please select a player first!');
                return;
            }
            
            const velo = parseFloat(document.getElementById('throw-velo').value);
            if (!velo) return;
            
            const existing = currentThrows.find(t => t.velocity === velo);
            if (existing) {
                existing.count++;
            } else {
                currentThrows.push({velocity: velo, count: 1});
            }
            
            document.getElementById('throw-velo').value = '';
            updatePreview();
            renderCurrentSession();
            renderEffortZones();
        }
        
        function renderCurrentSession() {
            const player = getCurrentPlayer();
            if (!player) return;
            
            const sessionDiv = document.getElementById('current-session');
            const list = document.getElementById('throw-list');
            const saveBtn = document.getElementById('save-btn');
            
            if (currentThrows.length === 0) {
                sessionDiv.classList.add('hidden');
                saveBtn.disabled = true;
                return;
            }
            
            sessionDiv.classList.remove('hidden');
            saveBtn.disabled = false;
            
            const total = currentThrows.reduce((sum, t) => sum + t.count, 0);
            const workload = calculateWorkload(currentThrows, player.maxVelo);
            
            list.innerHTML = currentThrows
                .sort((a, b) => b.velocity - a.velocity)
                .map(t => {
                    const pct = ((t.velocity / player.maxVelo) * 100).toFixed(1);
                    const zone = getZoneName(player.maxVelo, t.velocity).toUpperCase();
                    return `<div class="throw-item">
                        <span><strong>${t.velocity} mph</strong> (${pct}% - ${zone})</span>
                        <span>√ó ${t.count}</span>
                    </div>`;
                }).join('');
            
            document.getElementById('throw-count').textContent = total;
            document.getElementById('total-workload').textContent = workload.toFixed(3);
        }
        
        function renderEffortZones() {
            const player = getCurrentPlayer();
            if (!player) return;
            
            const breakdown = {};
            currentThrows.forEach(t => {
                const zone = getZoneName(player.maxVelo, t.velocity);
                breakdown[zone] = (breakdown[zone] || 0) + t.count;
            });
            
            const maxCount = Math.max(...Object.values(breakdown), 1);
            
            const zones = ['z1', 'z2', 'z3', 'z4', 'z5', 'z6', 'z7', 'z8', 'z9', 'z10'];
            const display = document.getElementById('effort-zones-display');
            
            display.innerHTML = `
                <div class="effort-zone-chart">
                    ${zones.map(z => {
                        const count = breakdown[z] || 0;
                        const height = (count / maxCount) * 100;
                        return `
                            <div class="zone-bar">
                                ${count > 0 ? `<div class="zone-count">${count}</div>` : ''}
                                <div class="zone-fill" style="height: ${height}%; background: ${ZONE_COLORS[z]};"></div>
                                <div class="zone-label">${z.toUpperCase()}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 0.5rem;">
                    <strong>Zone Guide:</strong>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem; font-size: 0.875rem;">
                        <div>Z1-Z3: Recovery/Warmup (53-64%)</div>
                        <div>Z4-Z6: Moderate Effort (64-81%)</div>
                        <div>Z7-Z8: High Intent (81-92%)</div>
                        <div>Z9-Z10: Max Effort (92-100%)</div>
                    </div>
                </div>
            `;
        }
        
        async function saveSession() {
            const player = getCurrentPlayer();
            if (!player) return;
            
            const workload = calculateWorkload(currentThrows, player.maxVelo);
            
            const breakdown = {};
            currentThrows.forEach(t => {
                const zone = getZoneName(player.maxVelo, t.velocity);
                breakdown[zone] = (breakdown[zone] || 0) + t.count;
            });
            
            const session = {
                date: document.getElementById('session-date').value,
                throws: [...currentThrows],
                maxVelo: player.maxVelo,
                workload,
                breakdown,
                sleepScore: document.getElementById('sleep-score').value ? parseInt(document.getElementById('sleep-score').value) : null,
                hrv: document.getElementById('hrv').value ? parseInt(document.getElementById('hrv').value) : null,
                rhr: document.getElementById('rhr').value ? parseInt(document.getElementById('rhr').value) : null
            };
            
            const existingIdx = player.sessions.findIndex(s => s.date === session.date);
            if (existingIdx !== -1) {
                player.sessions[existingIdx] = session;
            } else {
                player.sessions.push(session);
            }
            
            if (window.isFirebaseConfigured) {
                try {
                    const playerDoc = window.firestore.doc(window.db, 'players', player.id);
                    await window.firestore.setDoc(playerDoc, player);
                    console.log('‚úÖ Session saved to cloud');
                } catch (error) {
                    console.error('Error saving session:', error);
                    alert('Cloud save failed, saving locally only');
                }
            }
            
            localStorage.setItem('acwr_players', JSON.stringify(players));
            
            currentThrows = [];
            document.getElementById('sleep-score').value = '';
            document.getElementById('hrv').value = '';
            document.getElementById('rhr').value = '';
            renderCurrentSession();
            renderEffortZones();
            loadSessions();
            alert('‚úÖ Session saved!');
        }
        
        function loadSessions() {
            const player = getCurrentPlayer();
            const list = document.getElementById('sessions-list');
            
            if (!player || !player.sessions || player.sessions.length === 0) {
                list.innerHTML = '<p style="color: #6b7280;">No sessions yet</p>';
                return;
            }
            
            list.innerHTML = player.sessions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10)
                .map(s => `
                    <div class="session-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>${s.date}</strong>
                            <strong style="color: #522d80;">${s.workload.toFixed(2)} AU</strong>
                        </div>
                        ${s.breakdown ? '<div class="zone-badges">' + 
                            Object.entries(s.breakdown)
                                .sort((a, b) => b[0].localeCompare(a[0]))
                                .map(([z, c]) => `<span class="zone-badge ${z}">${z.toUpperCase()}: ${c}</span>`)
                                .join('') + '</div>' : ''}
                    </div>
                `).join('');
        }
        
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('players-tab').classList.toggle('hidden', tab !== 'players');
            document.getElementById('input-tab').classList.toggle('hidden', tab !== 'input');
            document.getElementById('dashboard-tab').classList.toggle('hidden', tab !== 'dashboard');
            
            if (tab === 'input') {
                updateCurrentPlayerDisplay();
                loadSessions();
                renderEffortZones();
            }
            if (tab === 'dashboard') {
                updateCurrentPlayerDisplay();
                loadDashboard();
            }
            if (tab === 'players') loadPlayers();
        }
        
        function loadDashboard() {
            const player = getCurrentPlayer();
            const content = document.getElementById('dashboard-content');
            
            if (!player) {
                content.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <h2>No player selected</h2>
                        <p style="color: #6b7280; margin-top: 0.5rem;">Select a player to view their dashboard</p>
                        <button onclick="showTab('players')" style="margin-top: 1rem;">Go to Players</button>
                    </div>
                `;
                return;
            }
            
            const data = calculateACWR(player.sessions);
            
            if (!data) {
                content.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <h2>Need at least 9 sessions</h2>
                        <p style="color: #6b7280; margin-top: 0.5rem;">${player.name} has ${player.sessions?.length || 0} sessions. Add ${9 - (player.sessions?.length || 0)} more to see the dashboard!</p>
                    </div>
                `;
                return;
            }
            
            const statusMessages = {
                optimal: 'Perfect! Stay consistent.',
                caution: 'Elevated - add recovery.',
                danger: 'High risk - reduce load!',
                under: 'Ready for more work.'
            };
            
            content.innerHTML = `
                <div class="hero-status ${data.status}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="font-size: 2rem; margin-bottom: 0.5rem;">Training Status for ${player.name}</h2>
                            <p style="font-size: 1.25rem;">${statusMessages[data.status]}</p>
                        </div>
                        <div style="font-size: 5rem; font-weight: 900;">${data.acwr}</div>
                    </div>
                    <span class="status-badge status-${data.status}" style="margin-top: 1rem;">${data.status}</span>
                </div>
                
                <div class="grid-3" style="margin-bottom: 1.5rem;">
                    <div class="metric-card green">
                        <div class="metric-title">Acute (9d)</div>
                        <div class="metric-value" style="color: #16a34a;">${data.acute}</div>
                    </div>
                    <div class="metric-card purple">
                        <div class="metric-title">Chronic (28d)</div>
                        <div class="metric-value" style="color: #522d80;">${data.chronic}</div>
                    </div>
                    <div class="metric-card ${parseFloat(data.readiness) >= 1.0 ? 'green' : 'orange'}">
                        <div class="metric-title">Readiness</div>
                        <div class="metric-value" style="color: ${parseFloat(data.readiness) >= 1.0 ? '#16a34a' : '#f59e0b'};">${data.readiness}</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                            ${parseFloat(data.readiness) >= 1.05 ? 'Well recovered' : parseFloat(data.readiness) >= 0.95 ? 'Normal' : 'Fatigued'}
                        </div>
                    </div>
                </div>
                
                ${data.readiness !== '1.00' ? `
                <div class="card" style="background: #eff6ff; border: 2px solid #bfdbfe;">
                    <h4 style="margin-bottom: 1rem;">üìä ACWR+ Analysis</h4>
                    <div class="grid-2" style="gap: 1rem; margin-bottom: 1rem;">
                        <div><span style="color: #3b82f6;">Raw ACWR (load only):</span> <strong>${data.rawAcwr}</strong></div>
                        <div><span style="color: #3b82f6;">Adjusted ACWR (with recovery):</span> <strong>${data.acwr}</strong></div>
                    </div>
                    <p style="color: #1e40af; font-size: 0.875rem;">
                        Your readiness modifier of <strong>${data.readiness}</strong> ${parseFloat(data.readiness) > 1.0 ? 'increases' : 'decreases'} your safe training threshold.
                        ${parseFloat(data.readiness) < 0.9 ? ' Consider reducing intensity or taking a recovery day.' : ''}
                    </p>
                </div>
                ` : ''}
            `;
        }
        
        // Initial load
        loadPlayersFromCloud();
        updateCurrentPlayerDisplay();
        if (currentPlayerId) {
            loadSessions();
            renderEffortZones();
        }
    </script>
</body>

</html>


